# Структура JSON-Файла
## Задача JSON-файлов, терминология
Файлы меню JSON описывают структуру и элементы меню, выводимые в KipTool. Меню состоит из трех основных типов элементов
* Папка (Folder)
* Параметр (Param)
* Значение (Value)

Значение определяет численную характеристику параметра. Набор значений образует возможные вариации численной характеристики параметра.

Параметр - это определение переменной из KIP-файла. На основе названия и описания определяется, за что параметр отвечает.

Папка - это элемент организации меню, который позволяет собирать параметры одного типа, или относящиеся к одному и тому-же узлу (GPU, CPU, RAM, и т.д.).

JSON-файл содержит описание каждого элемента меню: название, тип, описание и так далее.

## Базовые JSON-структуры меню

Любой элемент JSON состоит из 4 обязательных полей:

| Название поля | Описание поля |
| --- | --- |
| id         | Уникальный идентификатор элемента меню|
| name       | Имя, отображаемое в меню |
| parent_id  | Идентификатор родительского элемента |
| entry_type | Тип элемента |

* id - Десятичное число размером не более uint32_t (4,294,967,295). id не может быть равен 0, так как это число зарезервированно. id не должен повторяться между элементами.

* parent_id - Десятичное число размером не более uint32_t (4,294,967,295). В случае, если parent_id равен 0, данные элемент не является дочерним по отношению к любому другому элементу, и находится в главном меню KipTool. Если значение не равно 0, то элемент становится наследником элемента с данным ID, и находится ниже по уровню вложенности.

Комбинация ID позволяет отрисовывать **вложенность меню**, а так же производить **сортировку в порядке возрастания ID**.

* name - ASCII строка, название элемента. Отображается в интерфейсе.

* entry_type - ASCII строка, определяющая тип элемента. Существуют 3 различных вида элементов:

| Тип элемента| Описание элемента |
| --- | --- |
| FolderEntry| Элемент - Папка    |
| Param      | Элемент - Параметр |
| ParamValue | Элемент - Значение |

Базовый пример элемента представлен ниже.

```json
{
  "name": "RAM Params",
  "id": 3,
  "entry_type": "FolderEntry",
  "parent_id": 0
}
```

## Структура элемента FolderEntry

Элемент содержит дополнительные поля, изменяющие его внешний вид, или позволяющие загрузить дополнительные json-файлы:

| Название | Параметр | Описание |
| --- | --- | --- |
| folder_color| Число | Изменяет цвет папки, RGB значение, HEX или десятичное число, 24 бита |
| entries | Массив строк | Сообщает программе, что необходимо найти и загрузить дополнительные файлы описания JSON. Может содержать несколько элементов, перечисленных через запятую. Всегда **массив строк**!|
| hardware_type | Одно из трех: "Common" / "Erista" / "Mariko"|Указатель платформы, на которой должен отображаться элемент|

* hardware_type может принимать 3 значения: Common, Erista, Mariko. Common не обязателен, наличие hardware_type: "Common" эквивалентно отсутствию записи. Ограничения: Если указан hardware_type не Common, тогда все дочерние элементы должны иметь данный спецификатор у себя в полях, иначе невозможно определить, как выводить включение меню и его родительский элемент.

Пример элемента представлен ниже.

```json
{
  "name": "CPU Params", 		
  "id": 1,						
  "entry_type": "FolderEntry",	
  "entries": ["./CPU/cpu_example.json"],
  "parent_id": 0,
  "hardware_type": "Erista",
  "folder_color": "0x3686A0"
}

{
  "name": "GPU Params", 		
  "id": 2,						
  "entry_type": "FolderEntry",	
  "parent_id": 0,
  "hardware_type": "Mariko",
  "folder_color": "0x3686A0"
}

{
  "name": "RAM Params",
  "id": 3,
  "entry_type": "FolderEntry",
  "entries": ["./RAM/ram_example.json"],
  "parent_id": 0,
  "folder_color": "0x3686A0"
}
```

## Структура элемента ParamValue

Элемент должен всегда наследоваться от Param, т.е. в parent_id должен быть указан валидный ID элемента меню Param. Описывает возможные значения параметра. Содержит несколько полей:

| Название | Параметр | Описание |
| --- | --- | --- |
| description| "Строка" | Описание значения, выводится в меню как подсказка к конкретному значению, ASCII-строка. Не обязателен|
| parameter_type | Одно из трех: "Fixed" / "Manual" / "Range" | Тип значения, от типа зависит использование других полей значения.|
| value | Число | Значение Fixed значения, десятичное или HEX-число (как ASCII-строка) |
| min_value | Число | Минимальное значение Manual или Range значения |
| max_value | Число | Максимальное значение Manual или Range значения |
| value_step | Число | Шаг значения в Manual или Range типе|
| unit_name | "Строка" | Единица измерения значения. Если поле не задано - берется из Param|
| param_size | Число | Размер значения в байтах в KIP-е. На данный момент, как правило, все поля 4-х байтные. Элемент не обязателен. Если не задан, или сбрасывается в 4 байта, или берется из Param, если определен там. Если задан - переопределяет размер параметра для данного значения |
| delimiter | Число | Делитель значения, если, к примеру, в KIP-файле число слишком большое для восприятия. Не обязательный параметр. При определении в ParamValue, игнорирует значение, заданное в Param |
| hardware_type | Одно из трех: "Common" / "Erista" / "Mariko"|Указатель платформы, на которой должен отображаться элемент|


parameter_type, из таблицы, может иметь 3 значения:

* Fixed - Фиксированное значение. Может выступать в роли пресетного значения.
* Manual - Ручной выбор в диапазоне от min_value до max_value с шагом value_step. Включает границы.
* Range - Диапазон фиксированных значений. В JSON-файле имеет 1 запись, но в меню будут сгенерированны пункты в диапазоне min_value по max_value с шагом value_step включая границы. Для корректной генерации в поле name требуется добавить %d или %f в зависимости от типа значения, snprintf форматирование. Подробнее об этом ниже.

Примеры:

```json
{
  "name": "ECO ST2",
  "id": 100103,
  "entry_type": "ParamValue",
  "parent_id": 1001,
  "parameter_type": "Fixed",
  "value": 2
  "unit_name": " ",  
}

{
  "name": "1428MHz",
  "description": "CPU-Hi uV DEBUG",
  "id": 100201,
  "entry_type": "ParamValue",
  "parent_id": 1002,
  "parameter_type": "Fixed",
  "hardware_type": "Mariko",
  "value": 1440000
}

{
  "name": "Manual vaule",
  "id": 100105,
  "entry_type": "ParamValue",
  "parent_id": 1001,
  "parameter_type": "Manual",
  "min_value": 430, 
  "max_value": 670,  
  "value_step": 5,   
}

{
  "name": "pMeh 1: %d",
  "id": 30090201,
  "entry_type": "ParamValue",
  "parent_id": 300902,
  "parameter_type": "Range",
  "min_value": 0,
  "max_value": 4,
  "value_step": 1
}
```

## Структура элемента Param

Элемент должен наследоваться от FolderEntry. Определяет параметр в KIP-файле, который будет изменяться на основе выбранного в его подменю ParamValue - значения. Содержит следующие поля:

| Название | Параметр | Описание |
| --- | --- | --- |
| help| "Строка" | Строка помощи, выводится отдельно по требованию пользователя, максимальная длинна 1000 символов, ASCII|
| default_value | Массив чисел | Массив состоящий из 2-х переменных - ID ParamValue и значения, десятичные числа. Отображает универсальное дефолтное значение. В параметре не должно быть больше платформозависимых дефолтов.|
| default_value_erista | Массив чисел | Массив состоящий из 2-х переменных - ID ParamValue и значения, десятичные числа. Отображает дефолтное значение для Erista. В параметре может быть Mariko-зависимый дефолт, но не универсальный дефолт.|
| default_value_mariko | Массив чисел | Массив состоящий из 2-х переменных - ID ParamValue и значения, десятичные числа. Отображает дефолтное значение для Mariko. В параметре может быть Erista-зависимый дефолт, но не универсальный дефолт|
| offset | Число | Смещение параметра относительно начала таблицы, десятичное или HEX-число |
| unit_name | "Строка" | Единица измерения значения, не обязательный параметр|
| param_size | Число | Размер значения в байтах в KIP-е. На данный момент, как правило, все поля 4-х байтные. Элемент не обязателен. Если не задан, сбрасывается в 4 байта. |
| delimiter | Число | Делитель значения, если, к примеру, в KIP-файле число слишком большое для восприятия. Не обязательный параметр. Определяет значение в ParamValue, если в них не задан делитель |
| hardware_type | Одно из трех: "Common" / "Erista" / "Mariko"|Указатель платформы, на которой должен отображаться элемент|

* default_value определяется парой чисел, указывающих на ID ParamValue и его значение, если ID указывает не на Fixed-значение. Если он ссылается на Fixed - значение игнорируется, однако всеравно должно присутствовать в массиве и быть заполнено любым числом.


Примеры:

```json
{
  "name": "EMC Max Clock",
  "help": "RAM Frequency for RAM Optimized mode",
  "id": 3004,
  "entry_type": "Param",
  "parent_id": 3,
  "default_value": [
  "300401",
  "0"
  ],
  "delimiter": 1000,
  "offset": "0x2345",
  "unit_name": "MHz"
}


{
  "name": "pMeh 1",
  "help": "divMB Suppressor",
  "id": 300902,
  "entry_type": "Param",
  "parent_id": 3009,
  "default_value_erista": [
  "30090201",
  "2"
  ],
  "offset": "0x2345",
  "param_size": 2
}

{
  "name": "CPU LAUNCH CONTROL TARGET",
  "help": "Boost CPU frequency, while loading game",
  "id": 1002,
  "entry_type": "Param",
  "parent_id": 1,
  "delimiter": 1000,
  "default_value_mariko": [
  "100205",
  "0"
  ],
  "offset": "0x2345",
  "param_size": 2,
  "unit_name": "MHz"
}

{
  "name": "CPU LAUNCH CONTROL TARGET",
  "help": "Boost CPU frequency, while loading game",
  "id": 1002,
  "entry_type": "Param",
  "parent_id": 1,
  "delimiter": 1000,
  "hardware_type": "Mariko",
  "default_value_mariko": [
  "100205",
  "0"
  ],
  "offset": "0x2345",
  "param_size": 2,
  "unit_name": "MHz"
}
```

## Корневой JSON-файл описания KIP

Файлы кипа располагаются по пути /.kt/. Корневой JSON-файл представляет собой короткий JSON с парой определений, в котором описана версия CUST, с которой он работает, а так же минимально поддерживаемая версия KipTool и список авторов JSON-описания. В данном файле так же должна быть определена секций entries, в которй будут описаны пути до JSON-файлов или их части, если описанные JSON так же имеют свои секции entries.

```json
{
  "kip_version": 21,
  "kip_tool_min_version": "3.0.0" 
  "kip_json_authors": "kawaii_flesh, small23"
}

{
  "name": "CPU Params", 		
  "id": 1,						
  "entry_type": "FolderEntry",	
  "entries": ["./RAM/ram_example.json"],
  "parent_id": 0,
  "folder_color": "0x3686A0"
}
...

```

## Расположение и иерархия файлов описания меню

В папке /.kt./ для каждого корнего кип-файла создается папка с именем формата "kip%d", где %d это kip_version из корневого JSON-файла. Файл должен именоваться как "kip%d.json".
В каталоге с именем и номером версии KIP-а находятся вспомогательные файлы, отмеченые для загрузки. Пользователь может создать организацию файлов самостоятельно, как ему удобно. Пути должны быть прописаны относительные папки версии, т.е. для получения элемента 

```
.kt
│   kip21.json   
│   kip22.json    
│
└───kip21
│   │
│   └───CPU
│   │   │ 
│   │   │ some_json1.json
│   │   │ some_json2.json
│   │
│   └───GPU
│   │   │ 
│   │   │ some_json1.json
│   │   │ some_json2.json
│   │   
│   └───RAM
│       │ 
│       │ some_json1.json
│       │ some_json2.json
│   
└───kip22
    │   ...
    │   ...
```
